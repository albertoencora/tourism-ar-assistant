<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />

  <!-- üî• CLAVE PARA M√ìVIL -->
 <!-- VERSION: FIX-PROPERTY-08/01/2025 4:31 pm-OK -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <title>Airbnb AR Assistant</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      
    }

    a-scene {
      position: fixed;
      inset: 0;
      z-index: 1;
      
    }

    /* üî• UI ENCIMA DEL AR */
    #ui {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      gap: 8px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 12px;
    }

    #ui input {
      width: 220px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
    }

    #ui button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      background: #00c853;
      color: #fff;
      font-weight: bold;
      font-size: 16px;
    }
    #suggestions {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
  max-width: 92vw;
  padding: 6px 10px;
}

.suggestion-btn {
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.25);
  color: white;
  padding: 8px 10px;
  border-radius: 999px;
  font-size: 14px;
  cursor: pointer;
  user-select: none;
}

.suggestion-btn:active {
  transform: scale(0.97);
}
  </style>
</head>

<body>

  <!-- ESCENA AR -->
<a-scene
  embedded
  vr-mode-ui="enabled: false"
  arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;"
  device-orientation-permission-ui="enabled: false"
  cursor="rayOrigin: mouse"
>

  <a-camera position="0 0 0" look-controls="enabled: false">

  <a-entity
    id="arFloat"
    position="0 0 -2"
    animation="property: position;
               dir: alternate;
               dur: 3000;
               easing: easeInOutSine;
               loop: true;
               to: 0 0.12 -2">

    <a-entity id="arPanel" scale="0 0 0">

      <a-plane
        id="arPlane"
        width="1.85"
        height="1.05"
        color="#0f172a"
        opacity="0.72"
        material="shader: flat; transparent: true"
        >
      </a-plane>
      <a-plane
        width="1.9"
        height="1.1"
        color="#ffffff"
        opacity="0.08"
        position="0 0 -0.01"
        material="shader: flat; transparent: true"
        ></a-plane>
      <a-text
        id="arText"
        value=""
        width="1.45"
        color="#e5e7eb"
        align="center"
        position="0 0 0.15"
        wrap-count="30">
      </a-text>

<a-ring
  id="arLoader"
  radius-inner="0.05"
  radius-outer="0.08"
  position="0 -0.25 0.1"
  rotation="0 0 0"
  theta-start="20"
  theta-length="280"
  color="#ffffff"
  visible="false"
  animation="property: rotation; to: 0 0 360; loop: true; dur: 700; easing: linear"
></a-ring>
    </a-entity>

  </a-entity>
</a-camera>
</a-scene>
  <!-- üî• UI HTML -->
  <div id="ui">
    <input
      id="questionInput"
      placeholder="Ej: ¬øA qu√© hora es el check-in?"
    />
  
    <button id="sendBtn" onclick="askAI()">Enviar</button>
  </div>
  
  <script>

    const UI_THEME = {
  panel: "#0f172a",        // slate-900
  button: "#334155",       // slate-700
  buttonText: "#e5e7eb",   // gray-200
  spinner: "#94a3b8"       // slate-400
};

  function getLanguageFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("lang");
  }

  function getBrowserLanguage() {
    return navigator.language || navigator.userLanguage || "es-ES";
  }

  function getCurrentLanguage() {
    return getLanguageFromURL() || getBrowserLanguage();
  }

  const CURRENT_LANG = getCurrentLanguage();
</script>

<script>
  let BACKEND_SUGGESTIONS = null;
  const PROPERTY_CONFIG = {
    hotel_demo: {
    name: "Hotel Tamarindo",
    color: "#2196f3",
    welcome: {
      es: "Bienvenido al Hotel Tamarindo üè®",
      en: "Welcome to Hotel Tamarindo üè®"
    }
  },
  demo_property: {
    name: "Casa Playa Tamarindo",
    color: "#00c853",
    welcome: {
      es: "Bienvenido a Casa Playa Tamarindo, en que te puedo ayudar",
      en: "Welcome to Casa Playa Tamarindo üå¥"
    }
  },
  tourism_demo: {
    name: "asistente de turismo Costa Rica",
    color: "#00c853",
    welcome: {
      es: "Bienvenido a Costa Rica, en que te puedo ayudar",
      en: "Welcome to Costa Rica, let me know how can i help you"
    }
  },
   ferreteria_demo: {
    name: "Ferreteria Demo",
    color: "#2196f3",
    welcome: {
      es: "Bienvenido a ferreteria demo, buscas un producto, quieres saber de ofertas,pregunatame en que te puedo ayudar ",
      en: "Welcome to Hardware shop üè®"
    }
    
  }
};


  function getPropertyFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("property") || "tourism_demo";
}

const CURRENT_PROPERTY = getPropertyFromURL();
console.log("CURRENT_PROPERTY:", CURRENT_PROPERTY);
console.log("CONFIG:", PROPERTY_CONFIG[CURRENT_PROPERTY]);
</script>

  <script>
  let hideTimer = null;
  let currentUtterance = null;
  let audioUnlocked = false;
  

   function unlockAudio() {
    if (audioUnlocked) return;
    speechSynthesis.getVoices();
    const silent = new SpeechSynthesisUtterance("");
    silent.volume = 0;
    window.speechSynthesis.speak(silent);

  audioUnlocked = true;
}
  function applyBranding(playAudio = false) {
  const panel = document.getElementById("arPanel");
  const plane = document.getElementById("arPlane");
  const text = document.getElementById("arText");
  const btn = document.getElementById("sendBtn");

  if (!panel || !plane || !text) return;
 plane.setAttribute("color", UI_THEME.panel);
  plane.setAttribute("opacity", "0.72");

  if (btn) {
    btn.style.background = UI_THEME.button;
    btn.style.color = UI_THEME.buttonText;
  }
  const config = PROPERTY_CONFIG[CURRENT_PROPERTY];
  if (!config) return;

  //plane.setAttribute("color", config.color);
  panel.setAttribute("scale", "1 1 1");
  panel.setAttribute("visible", "true");

  const langKey = CURRENT_LANG.startsWith("en") ? "en" : "es";
  showARAnswer(config.welcome[langKey], playAudio);
}



function pickBestVoice(lang) {
  const voices = window.speechSynthesis.getVoices();
  if (!voices || voices.length === 0) return null;

  // Normalizar
  const short = (lang || "es").toLowerCase().split("-")[0]; // "es-CR" -> "es"

  // 1) Match exacto por lang completo
  let v = voices.find(v => v.lang && v.lang.toLowerCase() === (lang || "").toLowerCase());
  if (v) return v;

  // 2) Match por idioma base (es, en)
  const candidates = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith(short));

  if (candidates.length === 0) return null;

  // 3) Preferencias de espa√±ol (evita voces raras si existen)
  if (short === "es") {
    const preferred = ["es-CR", "es-MX", "es-ES", "es-US"];
    for (const p of preferred) {
      const match = candidates.find(v => v.lang.toLowerCase() === p.toLowerCase());
      if (match) return match;
    }
  }

  // 4) Si no, usa la primera candidata
  return candidates[0];
}


 //function getPreferredSpanishVoice() {
 // const voices = speechSynthesis.getVoices();

  // Prioridad 1: Google espa√±ol
//  let voice = voices.find(v => v.lang === "es-ES" && v.name.toLowerCase().includes("google"));
 // if (voice) return voice;

  // Prioridad 2: Google espa√±ol US
 // voice = voices.find(v => v.lang === "es-US" && v.name.toLowerCase().includes("google"));
 // if (voice) return voice;

  // Prioridad 3: Microsoft Spanish Spain
//  voice = voices.find(v => v.lang === "es-ES" && v.name.toLowerCase().includes("microsoft"));
//  if (voice) return voice;

  // Prioridad 4: cualquier voz es-*
//  voice = voices.find(v => v.lang.startsWith("es"));
//  return voice || null;
//}

function normalizeLang(lang) {
  if (!lang) return "es-ES";
  lang = lang.toLowerCase();

  if (lang.startsWith("es")) return "es-ES";
  if (lang.startsWith("en")) return "en-US";

  // fallback
  return "es-ES";
}

function pickBestVoice(targetLang) {
  const voices = speechSynthesis.getVoices();
  if (!voices || voices.length === 0) return null;

  const langPrefix = targetLang.split("-")[0]; // "es" o "en"

  // PRIORIDAD: Google voice en ese idioma
  let voice = voices.find(v =>
    v.lang.toLowerCase().startsWith(langPrefix) &&
    v.name.toLowerCase().includes("google")
  );
  if (voice) return voice;

  // SEGUNDA: Microsoft voice en ese idioma
  voice = voices.find(v =>
    v.lang.toLowerCase().startsWith(langPrefix) &&
    v.name.toLowerCase().includes("microsoft")
  );
  if (voice) return voice;

  // TERCERA: cualquier voz del idioma
  voice = voices.find(v => v.lang.toLowerCase().startsWith(langPrefix));
  if (voice) return voice;

  // fallback total
  return voices[0] || null;
}

function speak(text) {
  if (!text) return;

  // Cancelar lo anterior
  speechSynthesis.cancel();

  // Idioma seg√∫n tu CURRENT_LANG detectado
  const targetLang = normalizeLang(CURRENT_LANG);

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = targetLang;

  const voice = pickBestVoice(targetLang);
  if (voice) utterance.voice = voice;

  utterance.rate = 0.95;
  utterance.pitch = 1;
  utterance.volume = 1;

  speechSynthesis.speak(utterance);
}



function showARAnswer(text, speakAudio = true) {
 // const float = document.getElementById("arFloat");
  const panel = document.getElementById("arPanel");
  const arText = document.getElementById("arText");

  if (!panel || !arText) return;

    // Texto (forzar render)
  arText.setAttribute("value", "");
  setTimeout(() => {
    arText.setAttribute("value", text);
  }, 50);

    // Mostrar
  //float.setAttribute("visible", "true");
  panel.setAttribute("scale", "1 1 1");
   panel.setAttribute("visible", "true");

   if (speakAudio) speak(text);

    if (hideTimer) clearTimeout(hideTimer);
  hideTimer = setTimeout(() => {
    panel.setAttribute("scale", "0 0 0");
  }, 8000);

  //panel.setAttribute("animation__in", {
  //  property: "scale",
  //  from: "0.85 0.85 0.85",
  //  to: "1 1 1",
  //  dur: 300,
  //  easing: "easeOutBack"
 // });

    // Audio solo tras interacci√≥n
  //if (speakAudio) {
   // speak(text);
  //}

 // arText.setAttribute("value", text);
  //panel.setAttribute("scale", "1 1 1");

  // üîä HABLAR (idioma unificado)
 // speak(text);

  //if (hideTimer) clearTimeout(hideTimer);

  //hideTimer = setTimeout(() => {
  //  panel.setAttribute("scale", "0 0 0");
  //}, 8000);
}


function showLoader() {
  const panel = document.getElementById("arPanel");
  const arText = document.getElementById("arText");
  const loader = document.getElementById("arLoader");

  if (panel) {
    panel.setAttribute("scale", "1 1 1");
    panel.setAttribute("visible", "true");
  }

  if (arText) {
    arText.setAttribute("value", "");
  }

  if (loader) {
     loader.setAttribute("color", UI_THEME.spinner);
    loader.setAttribute("visible", "true");
  }
}

function hideLoader() {
  const loader = document.getElementById("arLoader");
  if (loader) loader.setAttribute("visible", "false");
}


 function setLoading(isLoading) {
  const btn = document.getElementById("sendBtn");
  const input = document.getElementById("questionInput");

  if (btn) {
    btn.disabled = isLoading;
    btn.textContent = isLoading ? "..." : "Enviar";
  }

  if (input) {
    input.disabled = isLoading;
  }
}


function renderSuggestions() {
  const container = document.getElementById("suggestions");
  if (!container || !BACKEND_SUGGESTIONS) return;

  const langKey = CURRENT_LANG.startsWith("en") ? "en" : "es";
  const list = BACKEND_SUGGESTIONS[langKey] || [];

  container.innerHTML = "";

  list.forEach((q) => {
    const btn = document.createElement("button");
    btn.className = "suggestion-btn";
    btn.textContent = q;

    btn.onclick = () => {
      const input = document.getElementById("questionInput");
      if (input) input.value = q;
      askAI();
    };

    container.appendChild(btn);
  });
}



function renderSuggestionsFromBackend() {
  const container = document.getElementById("suggestions");
  if (!container || !BACKEND_SUGGESTIONS) return;

  const langKey = CURRENT_LANG.startsWith("en") ? "en" : "es";
  const list = BACKEND_SUGGESTIONS[langKey] || [];

  container.innerHTML = "";

  list.forEach((q) => {
    const btn = document.createElement("button");
    btn.className = "suggestion-btn";
    btn.textContent = q;

    btn.onclick = () => {
      const input = document.getElementById("questionInput");
      if (input) input.value = q;
      askAI();
    };

    container.appendChild(btn);
  });
}

async function askAI() {
  

  unlockAudio();

  const input = document.getElementById("questionInput");
  if (!input || !input.value.trim()) return;

  const question = input.value.trim();

  try {
    setLoading(true);

    // UX: feedback inmediato
    showLoader();
    //("‚è≥ Pensando...", false);

    const res = await fetch(
      "https://gayla-subcalibre-destiny.ngrok-free.dev/ask",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          property_id: CURRENT_PROPERTY,
          question: question,
          //language: CURRENT_LANG
          language: CURRENT_LANG.startsWith("en") ? "en" : "es"
        })
      }
    );


    // Si backend respondi√≥ error
    if (!res.ok) {
      let detail = "";
       hideLoader();
      try {
        const err = await res.json();
        detail = err?.detail ? ` (${err.detail})` : "";
      } catch (e) {}

      showARAnswer("‚ö†Ô∏è Error del servidor. Intenta de nuevo." + detail, false);
      return;
    }

    const data = await res.json();
    if (data.suggestions) {
 // window.LAST_SUGGESTIONS = data.suggestions;
  //renderSuggestionsFromBackend();
  BACKEND_SUGGESTIONS = data.suggestions;
  renderSuggestionsFromBackend();
}
//window.RUNTIME_SUGGESTIONS = data.suggestions || {};
 //   const answer = data?.answer;
  //  if (!answer) {
  //    showARAnswer("‚ö†Ô∏è Respuesta vac√≠a. Intenta otra vez.", false);
   //   return;
   // }
   const answer = data?.answer;

hideLoader();

if (!answer) {
  showARAnswer("‚ö†Ô∏è Respuesta vac√≠a. Intenta otra vez.", false);
  return;
}

showARAnswer(answer, true);
input.value = "";


  } catch (err) {
    console.error("Fetch error:", err);
    hideLoader();
    showARAnswer("‚ö†Ô∏è Error de red. Revisa tu conexi√≥n o ngrok.", false);
  } finally {
    setLoading(false);
  }

 
}

speechSynthesis.onvoiceschanged = () => {
  console.log("‚úÖ Voces cargadas:", speechSynthesis.getVoices().length);
};
   
   
  
  </script>
  <script>
    const input = document.getElementById("questionInput");
    const scene = document.querySelector("a-scene");

    input.addEventListener("focus", () => {
      scene.style.visibility = "hidden";
      scene.style.pointerEvents = "none";
    });

    input.addEventListener("blur", () => {
       scene.style.visibility = "visible";
       scene.style.pointerEvents = "auto";
    });
</script>
<script>
 
 //const sceneTest = document.querySelector("a-scene");

//sceneTest.addEventListener("loaded", () => {
//  applyBranding(false);
 // renderSuggestions();
//});




</script>
<script>
const sceneTest = document.querySelector("a-scene");

sceneTest.addEventListener("loaded", async () => {
  applyBranding(false);

  setTimeout(() => {
  renderSuggestionsFromBackend();
}, 300);

  // üîπ Cargar suggestions al iniciar (llamada silenciosa)
  try {
    const res = await fetch(
      "https://gayla-subcalibre-destiny.ngrok-free.dev/ask",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          property_id: CURRENT_PROPERTY,
          question: "init",
          language: CURRENT_LANG.startsWith("en") ? "en" : "es"
        })
      }
    );

    if (!res.ok) return;

    const data = await res.json();

    if (data.suggestions) {
      BACKEND_SUGGESTIONS = data.suggestions;
      //renderSuggestionsFromBackend();
      renderSuggestions();
    }

  } catch (err) {
    console.warn("No se pudieron cargar suggestions iniciales");
  }
});
</script>
<div id="suggestions"></div>
</body>
</html>